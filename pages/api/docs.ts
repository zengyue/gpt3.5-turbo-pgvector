import { supabaseClient } from "@/lib/embeddings-supabase";
import { OpenAIStream, OpenAIStreamPayload } from "@/utils/OpenAIStream";
import { oneLine, stripIndent } from "common-tags";
import GPT3Tokenizer from "gpt3-tokenizer";
import { Configuration, OpenAIApi } from "openai";

const configuration = new Configuration({ apiKey: process.env.OPENAI_API_KEY });

export const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type"
};

if (!process.env.OPENAI_API_KEY) {
  throw new Error("Missing env var from OpenAI");
}

export const config = {
  runtime: "edge"
};

const handler = async (req: Request): Promise<Response> => {
  // Handle CORS
  if (req.method === "OPTIONS") {
    console.log("req.method ", req.method);
    return new Response("ok", { headers: corsHeaders });
  }

  const { question } = (await req.json()) as {
    question?: string;
  };

  if (!question) {
    return new Response("No prompt in the request", { status: 400 });
  }

  const query = question;

  // OpenAI recommends replacing newlines with spaces for best results
  const input = query.replace(/\n/g, " ");
  // console.log("input: ", input);

  const apiKey = process.env.OPENAI_API_KEY;

  // const embeddingResponse = await fetch(
  //   "https://api.openai.com/v1/embeddings",
  //   {
  //     method: "POST",
  //     headers: {
  //       Authorization: `Bearer ${apiKey}`,
  //       "Content-Type": "application/json"
  //     },
  //     body: JSON.stringify({
  //       input,
  //       model: "text-embedding-ada-002"
  //     })
  //   }
  // );

  // const embeddingData = await embeddingResponse.json();
  // const [{ embedding }] = embeddingData.data;
  const embedding = [
    -0.020069301, -0.00438795, -0.02425571, 0.015515168, -0.023152536,
    0.0037515028, -0.033660986, 0.00404144, 0.0045293826, -0.023590976,
    0.0118803475, 0.026532777, 0.026136765, -0.011208543, -0.027211655,
    0.011357047, 0.0027791527, 0.021978643, 0.043561276, 0.0027897602,
    -0.00834453, 0.027961247, 0.021455342, -0.016590057, -0.030181741,
    0.02905028, 0.022813097, -0.011321689, -0.015755605, 0.008054593,
    0.03250124, -0.0048193196, -0.019390425, -0.024411287, -0.015981896,
    0.012594583, -0.01357754, -0.0031185914, 0.023576833, -0.008401103,
    0.017311364, 0.025811471, 0.009730571, 0.012934022, 0.01931971, 0.008054593,
    0.008181882, 0.026122622, -0.031624354, 0.022841383, 0.0076161516,
    -0.0028657804, -0.022346368, -0.020677462, -0.007007991, -0.0123117175,
    0.005243618, 0.007729298, -0.012219787, -0.0150342975, -0.009582066,
    0.025104307, -0.027169224, -0.020903755, -0.018598402, -0.0066862316,
    -0.0060816067, -0.004207623, 0.016887067, 0.012997666, 0.020012729,
    0.01988544, -0.010897391, 0.021243194, 0.05015204, -0.0010801924,
    -0.028328972, -0.0022293332, 0.025104307, -0.0072554983, 0.02360512,
    -0.030096881, -0.018683262, 0.008231384, -0.010232657, 0.018174104,
    0.016717346, 0.0351036, -0.025047734, -0.0071953894, 0.014404922,
    0.039968885, 0.052924123, 0.033604413, 0.017947812, 0.023986988,
    0.0071564955, -0.010225585, 0.012820875, -0.025839757, 0.019645004,
    -0.001785588, -0.013683615, 0.003516371, -0.009285058, -0.008662754,
    0.0022770667, -0.011328761, -0.0061629303, -0.026278198, -0.015981896,
    0.014581713, 0.00404144, -0.027692525, -0.0036206774, -0.010847889,
    0.0127430875, -0.01677392, -0.018032672, 0.0011880348, 0.014723145,
    0.0021833675, 0.012870377, -0.016321335, 0.009277986, 0.008330387,
    -0.0048794285, -0.0018006152, -0.022926243, -0.0076656532, 0.088310584,
    0.009129481, 0.0144685665, -0.011222686, -0.01591118, 0.02257266,
    -0.013011809, -0.023011103, -0.010423591, -0.009150697, 0.017014356,
    -0.0035552648, 0.0023760695, -0.011986422, 0.0043349126, 0.043561276,
    -0.0095891375, 0.022586804, -0.024595149, -0.013726044, 0.009299201,
    -0.013429036, 0.02127148, 0.014164486, -0.0037479668, 0.00197829,
    -0.008698112, -0.0055653774, -0.008104094, -0.008825402, -0.012417792,
    0.030804045, 0.009475992, 0.024114277, 0.0014213987, 0.035329893,
    0.0014196308, -0.0106145255, 0.0041439785, 0.007800014, 0.0024167316,
    0.001824482, 0.022247367, 0.013634114, -0.000023120934, -0.0070857788,
    -0.008719327, -0.02446786, 0.002598826, 0.02032388, -0.011929849,
    -0.0010077081, 0.038186833, 0.0013409589, -0.030238314, -0.020550173,
    0.026447918, 0.00052639487, 0.0017908918, -0.008365745, -0.019531857,
    -0.0038752563, 0.00036794605, 0.011795488, -0.5652783, -0.04293897,
    -0.007029206, -0.024750724, 0.0048440704, 0.03869599, -0.008061665,
    0.014426136, -0.012198571, -0.05416873, -0.005590128, 0.006601372,
    0.022813097, -0.0012401881, -0.015939467, -0.02905028, -0.008719327,
    0.0028445655, -0.010183156, 0.004893572, -0.008231384, 0.024057705,
    -0.0068842373, 0.013365392, 0.026221626, 0.009681069, 0.011385334,
    -0.014553426, -0.0047450676, 0.04353299, -0.044466443, 0.023873841,
    0.015812177, -0.019305564, 0.056657944, -0.017325507, -0.0072554983,
    0.0005476098, 0.012714801, 0.02814511, -0.015571741, -0.018400395,
    0.0058942083, -0.0055441624, -0.0026730783, -0.014892865, 0.0025793791,
    -0.0024980553, 0.047464818, 0.009369917, 0.015232303, 0.0010907998,
    -0.024368856, -0.024566863, 0.0064917617, 0.009355774, 0.028682554,
    -0.009157768, 0.0141857015, 0.007029206, 0.01824482, 0.00959621,
    -0.033858992, -0.013492681, -0.0031150556, 0.0014479174, -0.044070434,
    -0.003065554, 0.01296938, 0.008683968, -0.005066827, 0.0027703133,
    -0.00011590853, -0.018725691, 0.017877094, 0.026900502, 0.0082950285,
    -0.02105933, -0.0012888056, -0.0057704546, 0.024170851, -0.005243618,
    -0.017438654, -0.0015363129, 0.0129057355, 0.0131744575, -0.031624354,
    -0.009971006, 0.00998515, 0.008104094, -0.017792236, -0.0024043561,
    0.017763948, -0.025924616, -0.0017953115, 0.023364684, -0.004197016,
    -0.01098225, 0.027551092, -0.022417085, -0.017580086, -0.00804045,
    -0.007743441, 0.004465738, 0.029729156, 0.027819814, -0.023124248,
    0.006926667, 0.0065341913, -0.02896542, -0.015769748, -0.00033634467,
    -0.016264763, -0.012601655, 0.007842444, -0.03117177, -0.016590057,
    0.009659855, 0.009631568, 0.017311364, 0.025104307, 0.007842444,
    0.036942225, 0.0115974825, 0.041609503, 0.024595149, -0.0072554983,
    0.019248992, -0.015670745, -0.025712468, -0.0023318718, 0.026433773,
    0.02400113, -0.01828725, 0.013733117, -0.010225585, -0.0020596138,
    0.018824695, 0.00016629393, -0.022869669, -0.030012023, -0.0025652358,
    0.020677462, -0.016575914, 0.0068418076, -0.011738915, -0.016646631,
    0.003967188, 0.01582632, -0.005353228, -0.018442826, -0.010770101,
    -0.017735662, 0.011986422, 0.004826391, 0.0053885863, 0.013570469,
    -0.006558942, -0.028130967, -0.030973764, -0.02503359, -0.015458596,
    -0.018810552, 0.0067852344, -0.0134573225, -0.022982815, -0.013436108,
    0.02131391, -0.007948519, -0.02368998, -0.013874549, -0.01820239,
    0.0021303303, 0.02131391, -0.00068197085, -0.003238809, -0.0052683684,
    -0.0065518706, -0.01599604, -0.026334772, 0.0141857015, -0.005137543,
    -0.02032388, 0.0048405346, 0.024581006, -0.0056785233, -0.0020737571,
    -0.012849162, -0.025627607, 0.029644297, 0.00006032989, -0.0011906866,
    -0.007181246, -0.0028498692, 0.004921858, 0.00056175306, 0.010253872,
    -0.0054098014, 0.003960116, 0.024453716, 0.019489428, 0.015557598,
    -0.013605827, -0.005682059, 0.03275582, -0.016010184, 0.0144685665,
    -0.0306909, 0.0030850011, 0.029814016, -0.0035092991, -0.018174104,
    -0.0048546777, -0.011434834, 0.012375362, -0.0019553073, 0.006926667,
    0.014454423, 0.010713528, 0.011335832, -0.002871084, 0.006173538,
    0.024170851, 0.010105368, 0.022162506, -0.0051729013, 0.00994272,
    0.02261509, 0.016349621, -0.025599321, -0.03753624, -0.0010907998,
    -0.021370484, -0.002526342, -0.0042005517, -0.0034085284, 0.020734036,
    -0.011060039, 0.032105226, -0.007856587, 0.009610353, -0.018796407,
    -0.00079644297, -0.015741462, 0.040874053, 0.006827664, 0.044070434,
    0.027706668, 0.0031168235, 0.011547981, -0.0041086203, 0.026179194,
    -0.0048405346, 0.022996958, 0.018188247, -0.011625769, 0.014935294,
    0.005586592, -0.0029064422, 0.031454634, 0.024241567, -0.0012278127,
    0.005685595, -0.0042288383, -0.016505199, -0.017325507, -0.013733117,
    -0.022643378, -0.03380242, 0.0073262146, -0.0037479668, -0.019036843,
    0.028767414, 0.011540909, 0.022035217, -0.036037054, 0.035810765,
    0.007538364, 0.004267732, 0.02858355, -0.025415458, -0.025599321,
    0.019871296, 0.0033607949, 0.0068771658, -0.01967329, -0.0062583974,
    0.009348703, 0.012035924, 0.0012454918, 0.032444663, -0.028937133,
    0.0002930309, -0.017749805, -0.02434057, 0.026278198, 0.010515522,
    -0.01941871, -0.0093062725, 0.02936143, -0.013252245, 0.011696486,
    -0.011095396, -0.04452302, 0.029531151, 0.016802207, -0.02009759,
    -0.0052542253, 0.020224879, -0.0026819177, -0.0046283854, -0.016618343,
    -0.013407821, -0.021511916, -0.004112156, -0.00726257, 0.011010537,
    -0.012262216, 0.023803126, -0.004501096, -0.0041262996, -0.009893218,
    -0.016632488, -0.017862951, -0.018414538, 0.04189237, -0.0030036774,
    -0.024184994, 0.0035057634, 0.032670956, -0.03182236, -0.0063008275,
    0.028696697, -0.0014735521, 0.0028463334, -0.0066508735, 0.027522806,
    -0.005416873, -0.004660208, -0.0037833252, 0.007474719, -0.022148363,
    -0.002545789, 0.0199703, -0.0051127924, 0.015119157, 0.030747471,
    0.009178983, -0.016703203, 0.016590057, -0.019277278, 0.021229051,
    0.014581713, -0.007842444, -0.017481083, -0.004232374, -0.0076302947,
    0.017155789, -0.009270914, 0.012566296, -0.01396648, 0.0023424793,
    -0.005724489, 0.01534545, 0.026306484, 0.0090092635, 0.0073120715,
    -0.012467294, 0.0070716357, 0.014221059, -0.0170285, -0.0041050846,
    -0.001436426, 0.007396931, -0.019432854, 0.0018156425, -0.03821512,
    0.019546, 0.0024538576, 0.008273814, -0.046503074, -0.011052966,
    0.0035623366, 0.0048582135, 0.0011367655, -0.005827028, 0.026094336,
    -0.027508663, 0.01400891, -0.013287604, 0.00613818, -0.024566863,
    0.0069054523, -0.018923696, 0.0062407185, -0.016986068, -0.012304646,
    -0.017763948, -0.0042217667, 0.034000423, 0.024057705, -0.007976805,
    -0.009270914, -0.019998586, -0.018315537, -0.0074464325, -0.007142352,
    -0.010628669, -0.0106145255, 0.018513542, -0.0008627396, -0.0055759847,
    -0.028215826, 0.009773, 0.016519342, -0.0072342833, 0.02511845,
    -0.037592813, -0.009992221, -0.014553426, -0.006951418, 0.00994272,
    0.013499753, -0.012792589, 0.012375362, -0.026080193, 0.0013321193,
    -0.0056007355, 0.012736016, -0.0042995545, 0.016618343, -0.017848808,
    -0.024609292, -0.00007121358, 0.009412347, -0.03100205, 0.0015451524,
    0.00955378, 0.021469485, 0.03665936, -0.0068453434, 0.019446999,
    -0.0019482357, -0.011555052, 0.04081748, -0.021045187, 0.005296655,
    0.017905382, -0.05015204, -0.004327841, -0.007064564, -0.060589775,
    -0.008500106, 0.027381374, 0.005957853, 0.01811753, 0.0047945688,
    -0.013733117, -0.029983735, 0.003161021, -0.009836645, 0.006389223,
    -0.0019181812, 0.011682342, -0.017226504, -0.0032335054, 0.0020719892,
    -0.00064661267, 0.044749312, -0.031200057, -0.0000025638133, 0.016505199,
    0.017622516, 0.013789689, -0.015062584, -0.00080837635, -0.0472951,
    -0.026023619, -0.0020136482, -0.005434552, -0.010706456, 0.0026447917,
    0.0029152818, 0.029559437, 0.031737503, 0.030238314, -0.012057139,
    -0.0017298989, -0.014553426, 0.010847889, -0.017622516, -0.0006090446,
    -0.035131887, 0.010324588, 0.019942012, -0.028739128, 0.01898027,
    -0.015486882, 0.003242345, -0.0009617424, -0.012120783, 0.013231031,
    0.0036807864, -0.05996747, 0.009822502, 0.020507744, -0.005455767,
    0.009461848, -0.032416377, -0.028937133, -0.008549607, 0.015020154,
    0.026348915, 0.011279259, 0.011837918, 0.005547698, 0.021695778,
    -0.027169224, 0.0040096175, 0.024807299, -0.012021781, -0.017820522,
    0.016674917, 0.031454634, -0.0022558519, 0.017820522, -0.018471112,
    -0.007927303, 0.0021250264, 0.0075242203, 0.005646701, 0.02429814,
    0.01128633, 0.00016960876, -0.03411357, -0.027508663, 0.010968107,
    -0.014836292, 0.041581217, 0.009638639, -0.044070434, 0.026136765,
    -0.0049784314, -0.030068595, -0.010423591, -0.018711548, 0.024708295,
    -0.016915353, -0.00540273, 0.017353794, -0.0021444736, -0.019729864,
    -0.050265186, -0.0024025883, 0.010218513, 0.021455342, 0.050830916,
    -0.005703274, -0.0054699103, -0.0052294745, 0.021200763, -0.00012065978,
    -0.027225798, -0.00023910968, 0.00349162, 0.009412347, -0.008245527,
    -0.02209179, -0.029191712, 0.026730783, -0.0046036346, -0.011929849,
    -0.005137543, -0.0011526766, -0.03337812, 0.020465314, -0.012198571,
    0.0458242, -0.009270914, 0.010925677, -0.014638286, 0.000912241,
    -0.021780638, 0.008429389, 0.008599109, 0.03821512, -0.006198289,
    -0.0056962026, 0.022303939, -0.0014231667, -0.016307192, -0.005088042,
    -0.02970087, 0.03714023, -0.01448271, 0.0009909129, -0.0171275,
    -0.0069903117, 0.040958915, 0.016929496, 0.0032069867, -0.008167739,
    -0.016745633, 0.00590128, 0.03810197, -0.01106711, -0.0126653, 0.01941871,
    -0.017452797, -0.020012729, -0.025146736, 0.0019164133, 0.0020649177,
    0.00038474117, 0.005837635, -0.013018881, -0.0063750795, 0.008973906,
    0.0121915, -0.013259317, 0.020041015, 0.026122622, -0.034000423,
    0.027650096, 0.02892299, -0.003917686, -0.008768829, 0.0042641964,
    -0.0138886925, -0.013223959, 0.003588855, -0.027508663, -0.028442118,
    -0.051170357, -0.009221413, 0.02905028, 0.0204936, 0.006898381, 0.018909553,
    0.015882894, -0.00021082314, -0.018725691, -0.006887773, -0.027720813,
    0.0020295593, 0.02858355, 0.019786436, -0.020437026, 0.0013497984,
    -0.032868963, -0.009376989, 0.0016963086, -0.019772293, -0.009087052,
    0.008641539, 0.010826674, 0.007248427, 0.013718973, -0.014949438,
    0.010579167, -0.023067676, 0.006173538, -0.0018651439, -0.0012269288,
    0.012467294, 0.018159961, -0.0018810551, -0.0019446998, -0.008606181,
    -0.05643165, 0.0041475142, -0.04228838, -0.01249558, -0.018711548,
    0.006382151, 0.023138393, 0.043334983, -0.0066508735, -0.027791528,
    -0.0024591612, -0.009787144, -0.013252245, -0.012934022, 0.0028640125,
    0.0111661125, 0.009928577, -0.007297928, 0.025019446, -0.008924404,
    -0.0029029064, -0.018485256, 0.0010996393, -0.032444663, -0.018867124,
    -0.005261297, -0.022586804, -0.026122622, -0.015387879, -0.016844636,
    -0.004341984, 0.020861326, 0.03753624, -0.025627607, 0.0071140653,
    -0.0115974825, -0.0147372885, 0.028088536, -0.009723499, -0.016519342,
    -0.026264055, 0.018442826, -0.0023831413, 0.029729156, -0.02347783,
    0.007078707, -0.02564175, -0.011555052, -0.006127572, -0.018060958,
    -0.02028145, -0.01141362, 0.0021851354, 0.02127148, 0.0025316456,
    0.007870731, 0.040053744, 0.0022982815, 0.022402942, -0.019333852,
    0.017226504, -0.03583905, -0.018527685, 0.003991938, -0.014751432,
    0.025302313, -0.0017051481, 0.021865498, -0.0026925253, -0.011088325,
    -0.0048865, -0.02468001, -0.041270066, 0.021992788, 0.0073474296,
    0.0024768403, 0.0043596635, -0.01625062, -0.01876812, -0.022516089,
    -0.0153313065, -0.0011509086, -0.008485963, 0.014496854, -0.0036206774,
    0.01967329, -0.008436461, -0.012509723, 0.002077293, 0.014164486,
    0.026942931, 0.30911535, -0.000678435, 0.0016034934, 0.029814016,
    0.0012322325, 0.027989535, 0.0058729933, 0.0028286544, 0.0044904887,
    0.025684182, -0.015798034, 0.0106145255, -0.03207694, -0.001416979,
    0.024156708, -0.023859698, -0.025175024, -0.02970087, -0.030266602,
    0.0020083445, 0.030747471, 0.0171275, 0.023209108, -0.019857153,
    0.016420338, 0.024793155, -0.024835585, -0.020691605, 0.031935506,
    0.00423591, -0.0054663746, 0.0034810128, -0.0118803475, 0.029898876,
    -0.038724277, -0.012870377, 0.015260589, 0.018032672, 0.041694365,
    0.0065200482, 0.01612333, -0.00019955271, -0.0018350894, 0.0012207411,
    0.024312284, -0.0068418076, -0.01975815, -0.017891238, -0.007510077,
    0.009214342, -0.023251537, -0.03139806, 0.01534545, 0.04514532, 0.004826391,
    0.0073120715, 0.03813026, -0.005148151, 0.011321689, 0.019616717,
    -0.017367937, 0.017664947, -0.0010041723, 0.0101690125, -0.009497207,
    0.0025952903, -0.023194965, -0.011696486, 0.009483064, -0.0069584893,
    -0.01335832, -0.011137826, 0.010515522, 0.015444452, -0.028385546,
    -0.017877094, 0.019093417, -0.0031787003, 0.029163426, 0.036829077,
    -0.015925324, -0.009228485, -0.0024167316, -0.012728944, 0.023746552,
    -0.03306697, 0.008259671, 0.0052542253, -0.0044091647, -0.028696697,
    0.0037974683, 0.0057103457, 0.0015513401, 0.020239022, 0.012799661,
    -0.0022523159, -0.008287957, 0.03878085, -0.01690121, 0.012573368,
    -0.041100346, 0.028625982, 0.0034704052, 0.012545082, 0.0060886783,
    -0.00036639912, -0.008584966, -0.0031150556, 0.028781557, -0.017537657,
    -0.006177074, -0.039148577, 0.0017405064, -0.013648257, -0.010437734,
    -0.021101762, 0.0160809, 0.0018474648, -0.01223393, -0.0007425217,
    0.0115974825, -0.026179194, -0.0030938406, 0.016194046, -0.04367442,
    0.0028233505, 0.005476982, 0.002347783, 0.00799802, -0.04737996,
    0.029418005, -0.03134149, 0.018131673, -0.017042642, 0.002075525,
    0.0073827878, -0.024142563, -0.022714093, -0.0026306484, -0.017976098,
    0.0090234075, -0.0094406335, -0.00942649, -0.007623223, 0.022558518,
    0.028031964, -0.008761757, 0.0010819603, 0.022968672, -0.032670956,
    -0.013018881, -0.00380454, -0.007976805, -0.025486175, 0.02040874,
    -0.023180822, -0.0072095324, -0.032529525, 0.007644438, 0.0012446078,
    -0.02499116, -0.005353228, 0.0054486953, -0.018301394, -0.0070751715,
    -0.027551092, -0.18137331, 0.012368291, 0.032670956, -0.021639206,
    -0.000040192303, 0.014680715, 0.006406902, 0.005491125, -0.012644084,
    0.0050137895, 0.013450251, -0.0020808289, -0.0064564035, 0.0061629303,
    -0.016844636, 0.016335478, -0.028526979, 0.0022364047, 0.026957076,
    0.018301394, 0.04076091, -0.017636659, -0.007103458, 0.0018527686,
    0.015161587, 0.007432289, -0.019645004, 0.033576127, 0.0056254864,
    -0.012955236, 0.012325861, -0.014277632, 0.026660066, -0.02200693,
    -0.0059295665, -0.018626688, -0.021328053, -0.038441412, -0.040166892,
    0.01145605, 0.01828725, 0.029531151, 0.023803126, 0.009433562, 0.0059118876,
    0.019376282, 0.0047592106, -0.023788983, 0.012842091, -0.0005723605,
    0.02650449, -0.013259317, 0.029842302, 0.007870731, 0.03337812,
    0.0019942012, 0.0020613817, 0.015204017, -0.0008313592, -0.010840817,
    -0.019461142, -0.025627607, 0.036602788, 0.010289229, -0.018004384,
    -0.018584259, -0.04172265, 0.024397142, -0.011526766, -0.008153596,
    -0.004451595, -0.02871084, 0.023788983, -0.0044551305, 0.027551092,
    0.029502865, -0.012686514, -0.022586804, 0.005745704, 0.016293049,
    -0.017268935, 0.033972137, -0.005434552, -0.011915706, -0.013365392,
    0.013945266, 0.015402023, 0.011936921, -0.0118803475, -0.01128633,
    0.026999505, -0.018216534, 0.0005692667, -0.019503571, 0.012813804,
    -0.00046849585, 0.008429389, -0.004172265, 0.007856587, -0.011731843,
    0.014426136, -0.005187045, -0.03753624, -0.003394385, 0.031058624,
    -0.0025175023, 0.0069903117, 0.03869599, 0.046276785, 0.008019235,
    -0.034085285, 0.017410368, -0.0040697264, -0.00066871155, 0.014348349,
    0.03182236, 0.0070362776, 0.011816703, -0.0041439785, 0.018612545,
    -0.012530939, -0.030577753, 0.023110105, 0.032444663, -0.007948519,
    -0.028512836, -0.06262641, -0.016066756, 0.02511845, 0.03810197,
    0.008266742, 0.009136553, 0.006463475, -0.00025612582, -0.008309172,
    0.031058624, -0.02200693, -0.01141362, -0.006718054, 0.014284704,
    0.004981967, 0.0066756243, 0.0018881267, -0.019347996, 0.009843716,
    0.032529525, -0.0024803763, -0.02892299, 0.00856375, -0.0054805176,
    0.004207623, 0.00019336503, -0.0078636585, 0.017169932, 0.027848102,
    0.007821229, 0.04780426, -0.033236686, -0.008627395, 0.0047061737,
    -0.019560143, -0.022035217, 0.00851425, -0.026094336, 0.024623435,
    -0.0017033803, -0.0024361785, 0.009801287, 0.005271904, -0.021427056,
    -0.014822149, -0.0017590694, -0.010352874, 0.035273317, -0.003244113,
    -0.01612333, -0.025472032, -0.021158334, -0.02161092, -0.011123683,
    0.013627042, -0.006870094, 0.0006077187, 0.015868751, -0.011215614,
    -0.0033378121, -0.005936638, -0.0057315608, -0.0061240364, -0.0021444736,
    0.0005962273, 0.00015458153, 0.010466021, -0.009030479, -0.0046884944,
    0.020889612, -0.022897957, 0.03861113, -0.02009759, 0.025358886,
    -0.039403155, 0.008224312, -0.026009476, -0.017565943, 0.011682342,
    -0.020041015, 0.003666643, -0.027480377, 0.009949791, -0.029757444,
    0.01837211, 0.013033025, -0.010550881, -0.011915706, 0.002328336,
    -0.04769111, 0.008867831, 0.019729864, 0.048143696, -0.020168304,
    -0.012127855, 0.008910261, 0.00395658, 0.02139877, -0.010437734,
    -0.004660208, -0.008351602, -0.033038683, -0.07354501, 0.018174104,
    0.025542747, 0.0012622869, -0.0066897674, 0.009334559, 0.030125167,
    0.0002271763, -0.016858779, -0.012693586, -0.012318789, 0.004288947,
    -0.002423803, -0.008959763, -0.03445301, -0.020507744, -0.008606181,
    0.0032723993, 0.018626688, 0.017749805, 0.004115692, 0.0012888056,
    -0.014638286, -0.0011526766, -0.008153596, 0.015571741, -0.007856587,
    0.014475638, -0.012736016, -0.0030531788, 0.00804045, 0.015656602,
    -0.01569903, -0.005257761, -0.016491054, -0.031426348, -0.005491125,
    0.014129128, 0.021879641, 0.0058517787, -0.0050385403, -0.017735662,
    0.024807299, -0.01820239, -0.020210735, -0.007814158, -0.012523867,
    -0.005066827, 0.020210735, -0.034651015, -0.008698112, 0.01262287,
    -0.0022664592, -0.024057705, -0.009963934, -0.034170143, -0.023845555,
    0.012983523, 0.029304858, -0.03592391, -0.0064564035, 0.008507178,
    -0.0025422531, -0.005282512, 0.0060462486, 0.00092461635, -0.021370484,
    -0.00009618529, 0.019560143, -0.04786083, -0.015444452, 0.0110317515,
    0.0071458877, 0.014114985, -0.0005692667, 0.0346793, 0.01876812,
    -0.019645004, 0.0017104519, 0.02170992, 0.001531893, -0.021158334,
    -0.033180114, 0.017198218, 0.020960327, 0.023803126, -0.0035641044,
    -0.0001321512, -0.0011323456, 0.024538577, -0.0027296513, 0.017976098,
    -0.0077929427, 0.010784244, 0.0041404427, 0.031624354, -0.016533485,
    0.008429389, -0.0028374938, -0.0036189095, 0.003981331, -0.0030301958,
    0.016674917, -0.04064776, -0.013938194, 0.021625062, -0.009108267,
    -0.026462061, -0.0031486459, 0.013733117, -0.042429812, -0.00633265,
    -0.0166042, 0.0053001908, -0.011547981, 0.007552507, -0.020550173,
    -0.014192773, -0.021582631, 0.010183156, 0.009143625, 0.0043207696,
    0.004448059, 0.0056537725, 0.02009759, 0.0088749025, 0.0055017327,
    -0.017778093, 0.0062371828, 0.01799024, -0.010656955, -0.00562195,
    -0.0062548616, -0.03479245, -0.005643165, -0.001921717, -0.0073262146,
    0.027975392, -0.0141362, 0.0517078, -0.0063715437, -0.0009670462,
    -0.019305564, -0.025740754, 0.005438088, -0.009829573, -0.019404568,
    -0.036829077, -0.019984443, 0.013676544, -0.021455342, 0.005823492,
    0.0081606675, -0.015670745, 0.01534545, -0.01327346, -0.006696839,
    -0.031030336, 0.03493388, 0.017268935, 0.016872922, 0.015571741,
    -0.0024344106, 0.0066756243, 0.00026120854, 0.008931476, -0.0063609364,
    -0.0043136976, -0.0030620182, 0.0020065766, 0.018386252, -0.0249063,
    -0.028498692, 0.017014356, -0.023788983, -0.0025846828, -0.012057139,
    0.018499399, 0.037621103, -0.0015778587, 0.0030408034, -0.013365392,
    0.00045391062, 0.0009237324, 0.025967047, 0.0094547765, -0.010190227,
    -0.00873347
  ];
  // console.log("embedding: ", embedding);

  const { data: documents, error } = await supabaseClient.rpc(
    "match_page_sections",
    {
      embedding: embedding,
      match_threshold: 0.01, // Choose an appropriate threshold for your data
      match_count: 10,
      min_content_length: 10 // Choose the number of matches
    }
  );

  // console.log("documents: ", documents);

  if (error) console.error(error);

  const tokenizer = new GPT3Tokenizer({ type: "gpt3" });
  let contextText = "";
  let tokenCount = 0;

  // Concat matched documents
  if (documents) {
    for (let i = 0; i < documents.length; i++) {
      const document = documents[i];
      const content = document.content;
      const url = document.path;
      const encoded = tokenizer.encode(content);
      // console.log(encoded);
      tokenCount += encoded.text.length;

      // Limit context to max 1500 tokens (configurable)
      if (tokenCount > 1500) {
        break;
      }

      contextText += `${content.trim()}`;
    }
  }

  console.log("contextText: ", contextText);

  if (!contextText) {
    return new Response("No context", { status: 400 });
  }

  const systemContent = `You are a helpful assistant. When given CONTEXT you answer questions using only that information,
  and you always format your output in markdown. You include code snippets if relevant. If you are unsure and the answer
  is not explicitly written in the CONTEXT provided, you say
  "Sorry, I don't know how to help with that."  If the CONTEXT includes 
  source URLs include them under a SOURCES heading at the end of your response. Always include all of the relevant source urls 
  from the CONTEXT, but never list a URL more than once (ignore trailing forward slashes when comparing for uniqueness). Never include URLs that are not in the CONTEXT sections. Never make up URLs`;

  const userContent = `CONTEXT:
  F2，一个专注于移动，开箱即用的可视化解决方案，完美支持 H5 环境同时兼容多种环境（node, 小程序，weex）。完备的图形语法理论，满足你的各种可视化需求。专业的移动设计指引为你带来最佳的移动端图表体验
  
  QUESTION: 
  F2 是什么?    
  `;

  const assistantContent = `
  如下是一个使用 F2 快速生成柱图图的示例，你也可以在[官网](https://f2.antv.antgroup.com/examples)查看更多的示例。
  \`\`\`html
<canvas id="mountNode"></canvas>
\`\`\`

\`\`\`jsx
import { Canvas, Chart, Axis, Interval, Tooltip } from '@antv/f2';

const data = [
  { genre: 'Sports', sold: 275 },
  { genre: 'Strategy', sold: 115 },
  { genre: 'Action', sold: 120 },
  { genre: 'Shooter', sold: 350 },
  { genre: 'Other', sold: 150 },
];

// 获取 canvas context
const context = document.getElementById('mountNode').getContext('2d');
const { props } = (
  <Canvas context={context} pixelRatio={window.devicePixelRatio}>
    <Chart data={data}>
      <Axis field="genre" />
      <Axis field="sold" />
      <Interval x="genre" y="sold" color="genre" />
      <Tooltip />
    </Chart>
  </Canvas>
);

// 根据具体的运行环境实例化
const canvas = new Canvas(props);
canvas.render();
\`\`\`
  `;

  const userMessage = `CONTEXT:
  ${contextText}
  
  USER QUESTION: 
  ${query}  
  `;

  const messages = [
    {
      role: "system",
      content: systemContent
    },
    {
      role: "user",
      content: userMessage
    }
  ];

  console.log("messages: ", messages);

  const payload: OpenAIStreamPayload = {
    model: "gpt-3.5-turbo-0301",
    messages: messages,
    temperature: 0,
    top_p: 1,
    frequency_penalty: 0,
    presence_penalty: 0,
    max_tokens: 2000,
    stream: true,
    n: 1
  };

  const stream = await OpenAIStream(payload);
  return new Response(stream);
};

export default handler;
